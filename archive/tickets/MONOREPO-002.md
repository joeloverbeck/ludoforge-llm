# MONOREPO-002: Migrate from npm to pnpm

**Status**: ✅ COMPLETED
**Spec**: 35 — Monorepo Restructure & Build System (D0)
**Priority**: P0
**Depends on**: MONOREPO-001
**Blocks**: MONOREPO-003

---

## Objective

Replace npm with pnpm as the package manager. Delete `package-lock.json` and `node_modules/`, configure corepack, create `.npmrc`, add the `packageManager` field, and remove npm-command aliasing from root scripts that self-invoke package scripts. Verify the project still builds and tests pass under pnpm.

---

## Tasks

1. Delete `package-lock.json`.
2. Delete `node_modules/`.
3. Ensure corepack is enabled: `corepack enable && corepack prepare pnpm@10.12.1 --activate`.
4. Add `"packageManager": "pnpm@10.12.1"` to root `package.json`.
5. Update root `package.json` scripts to avoid `npm run ...` self-invocation aliasing, using `pnpm run ...` for any script-to-script calls.
6. Create `.npmrc` at repo root:
   ```
   shamefully-hoist=false
   strict-peer-dependencies=true
   ```
7. Run `pnpm install` and verify it succeeds.
8. Run `pnpm run build && pnpm test` and verify all tests still pass.
9. Run `pnpm run schema:artifacts:check`, `pnpm run lint`, and `pnpm run typecheck`.
10. Add `.npmrc` and updated `package.json` to git. Do NOT commit `pnpm-lock.yaml` ignore — it should be tracked.

---

## Files Expected to Touch

| Action | File |
|--------|------|
| Delete | `package-lock.json` |
| Delete | `node_modules/` (not tracked, but removed from disk) |
| Create | `.npmrc` |
| Edit | `package.json` (add `packageManager` and remove `npm run` aliasing in root scripts) |
| Create | `pnpm-lock.yaml` (auto-generated by `pnpm install`) |

---

## Out of Scope

- Creating `pnpm-workspace.yaml` (that's MONOREPO-003).
- Creating `turbo.json` (that's MONOREPO-003).
- Moving any source files or directories.
- Changing `tsconfig.json`, `eslint.config.js`, or any source/test files.

---

## Acceptance Criteria

### Tests that must pass

- `pnpm install` exits 0 with no peer dependency errors.
- `pnpm run build` exits 0.
- `pnpm test` exits 0 (same test count as MONOREPO-001 baseline).
- `pnpm run schema:artifacts:check` exits 0.
- `pnpm run lint` exits 0.
- `pnpm run typecheck` exits 0.

### Invariants that must remain true

- `package-lock.json` no longer exists.
- `.npmrc` exists with `shamefully-hoist=false` and `strict-peer-dependencies=true`.
- `package.json` contains `"packageManager": "pnpm@10.12.1"`.
- Root `package.json` scripts contain no `npm run` self-invocation aliasing.
- No source code or test code modified.
- All existing tests produce identical results.

---

## Architecture Reassessment

The migration is beneficial and should proceed:

- pnpm is a better architectural fit for the upcoming workspace split in Spec 35 than npm lockfile semantics.
- Enforcing direct pnpm script invocation now avoids package-manager aliasing and reduces migration ambiguity in later tickets.
- Keeping source/test logic untouched while tightening package-manager semantics provides a clean, low-risk foundation for MONOREPO-003+.

---

## Outcome

- **Completion date**: 2026-02-17
- **What changed vs. original plan**:
  - Added explicit no-aliasing migration scope for root script self-invocations (`npm run ...` to `pnpm run ...`), aligned with pnpm-first architecture.
  - Added explicit lint/typecheck verification to acceptance checks.
- **Verification results**:
  - `pnpm install`: pass
  - `pnpm run build`: pass
  - `pnpm test`: pass (`243` tests, `243` passed, `0` failed)
  - `pnpm run test:e2e`: pass (`3` tests, `3` passed, `0` failed) *(extra hard-check beyond original scope)*
  - `pnpm run schema:artifacts:check`: pass
  - `pnpm run lint`: pass
  - `pnpm run typecheck`: pass
