# SESSMGMT-009: Dexie.js Database and Save Manager (Spec 43 D5 — persistence layer)

**Status**: ✅ COMPLETED
**Priority**: MEDIUM
**Effort**: Medium
**Engine Changes**: None — runner-only
**Deps**: None (targets existing Session/D1 runner architecture)

## Problem

The runner needs IndexedDB-backed persistence for saving and loading games. This ticket implements the database schema and CRUD operations.

## Assumption Reassessment (2026-02-20)

1. `packages/runner/src/persistence/save-manager.ts` already exists as a stub and is already consumed by `GameSelectionScreen`.
2. Session navigation and move accumulation are already implemented in runner (`session-store`, `App.tsx` integration); this ticket should not redesign those flows.
3. Spec 43 D5 now uses `seed: number` (non-negative safe integer), not stringified `BigInt`.
4. `listSavedGames()` is already used by UI to render summary rows; returning full move-history payloads for list views is unnecessary coupling and avoidable read overhead.
5. Vitest runs in node by default; IndexedDB tests require explicit test polyfill setup (for example `fake-indexeddb`).

Scope is updated below to align with these realities.

## What to Change

### 1. Add `dexie` dependency

```bash
pnpm -F @ludoforge/runner add dexie
```

### 2. Create `packages/runner/src/persistence/game-db.ts`

Define the Dexie database class:

```typescript
import Dexie from 'dexie';

export interface SavedGameRecord {
  readonly id: string;           // Auto-generated UUID
  readonly gameId: string;       // Bootstrap target id (e.g., 'fitl', 'texas')
  readonly gameName: string;     // Human-readable (e.g., 'Fire in the Lake')
  readonly displayName: string;  // User-provided save name
  readonly timestamp: number;    // Date.now()
  readonly seed: number;         // Original seed (non-negative safe integer)
  readonly moveHistory: Move[];  // Complete move sequence
  readonly playerConfig: PlayerSeatConfig[];
  readonly playerId: number;     // Which seat the human was playing
  readonly moveCount: number;    // Length of moveHistory (for display)
  readonly isTerminal: boolean;  // Whether the game was finished
}
```

Dexie database class with a `saves` table, indexed by `id`, `gameId`, and `timestamp`.

### 3. Implement `packages/runner/src/persistence/save-manager.ts` (replace stub)

Pure functions that operate on the Dexie database:

- `saveGame(record: Omit<SavedGameRecord, 'id'>): Promise<string>` — generates UUID via `crypto.randomUUID()`, stores record, returns id.
- `loadGame(id: string): Promise<SavedGameRecord | undefined>` — retrieves by id.
- `listSavedGames(gameId?: string): Promise<SavedGameListItem[]>` — lists lightweight save summaries (no `moveHistory`/`playerConfig` payloads), optionally filtered by gameId, ordered by timestamp descending.
- `deleteSavedGame(id: string): Promise<void>` — deletes by id.

## Files to Touch

- `packages/runner/package.json` (add `dexie` dependency)
- `packages/runner/package.json` (add `fake-indexeddb` dev dependency for persistence tests)
- `packages/runner/src/persistence/game-db.ts` (new)
- `packages/runner/src/persistence/save-manager.ts` (implement existing stub)
- `packages/runner/test/persistence/save-manager.test.ts` (new)

## Out of Scope

- UI dialogs for save/load (SESSMGMT-010)
- Move accumulation wiring (SESSMGMT-008)
- Replay controller (SESSMGMT-011, 012)
- Game selection screen save list integration (wired in SESSMGMT-010)
- Session store changes (done in SESSMGMT-004)

## Acceptance Criteria

### Tests That Must Pass

1. **`saveGame` creates record**: After `saveGame(record)`, the returned id can be used with `loadGame(id)` to retrieve the same record.
2. **`loadGame` returns undefined for missing id**: `loadGame('nonexistent')` returns `undefined`.
3. **`listSavedGames` returns all**: After saving 3 games, `listSavedGames()` returns all 3.
4. **`listSavedGames` filters by gameId**: After saving 2 FITL and 1 Texas games, `listSavedGames('fitl')` returns 2.
5. **`listSavedGames` orders by timestamp desc**: Most recent save appears first.
6. **`deleteSavedGame` removes record**: After deleting, `loadGame(id)` returns `undefined`.
7. **Seed stored as number**: Seed persists as a non-negative safe integer and round-trips exactly.
8. **Existing runner tests**: `pnpm -F @ludoforge/runner test` passes.

### Invariants

1. `SavedGameRecord.id` is a UUID generated by `crypto.randomUUID()`.
2. `SavedGameRecord.seed` is a non-negative safe integer (`number`).
3. `moveHistory` is stored as a complete array in a single IndexedDB record (no chunking).
4. The database name and table name are stable (no random suffixes) so saves persist across sessions.
5. No direct Dexie imports outside of `persistence/` — the save manager is the public API.
6. `listSavedGames()` must return projection rows suitable for selection lists and must not expose full move-history payloads.

## Outcome

- **Completion date**: 2026-02-20
- **What changed**:
  - Added `dexie` runtime dependency and `fake-indexeddb` dev dependency in `packages/runner/package.json`.
  - Implemented `packages/runner/src/persistence/game-db.ts` with a stable Dexie DB/schema (`ludoforge-runner`, `saves` table).
  - Replaced the `save-manager` stub with working `saveGame`/`loadGame`/`listSavedGames`/`deleteSavedGame`.
  - Added comprehensive persistence tests in `packages/runner/test/persistence/save-manager.test.ts`.
- **Deviations vs original plan**:
  - `listSavedGames()` now returns summary rows (`SavedGameListItem`) instead of full `SavedGameRecord` payloads. This avoids loading large `moveHistory` arrays for selection lists and keeps the list API decoupled from full save payloads.
  - Seed contract standardized to `number` (non-negative safe integer) per current Spec 43 D5 and current session architecture.
- **Verification**:
  - `pnpm -F @ludoforge/runner test` passed.
  - `pnpm -F @ludoforge/runner lint` passed.
  - `pnpm -F @ludoforge/runner typecheck` passed.
