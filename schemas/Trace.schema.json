{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "Trace.schema.json",
  "title": "SerializedGameTrace",
  "type": "object",
  "additionalProperties": false,
  "required": ["gameDefId", "seed", "moves", "finalState", "result", "turnsCount", "stopReason"],
  "properties": {
    "gameDefId": { "type": "string" },
    "seed": { "type": "number" },
    "moves": {
      "type": "array",
      "items": { "$ref": "#/definitions/serializedMoveLog" }
    },
    "finalState": { "$ref": "#/definitions/serializedGameState" },
    "result": {
      "anyOf": [
        { "$ref": "#/definitions/terminalResult" },
        { "type": "null" }
      ]
    },
    "turnsCount": { "type": "number" },
    "stopReason": {
      "enum": ["terminal", "maxTurns", "noLegalMoves"]
    }
  },
  "definitions": {
    "hexBigInt": {
      "type": "string",
      "pattern": "^0x[0-9a-f]+$"
    },
    "playerSel": {
      "oneOf": [
        { "const": "actor" },
        { "const": "active" },
        { "const": "all" },
        { "const": "allOther" },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["id"],
          "properties": {
            "id": { "type": "integer" }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["chosen"],
          "properties": {
            "chosen": { "type": "string" }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["relative"],
          "properties": {
            "relative": { "enum": ["left", "right"] }
          }
        }
      ]
    },
    "triggerEvent": {
      "oneOf": [
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["type", "phase"],
          "properties": {
            "type": { "const": "phaseEnter" },
            "phase": { "type": "string" }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["type", "phase"],
          "properties": {
            "type": { "const": "phaseExit" },
            "phase": { "type": "string" }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["type"],
          "properties": {
            "type": { "const": "turnStart" }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["type"],
          "properties": {
            "type": { "const": "turnEnd" }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["type"],
          "properties": {
            "type": { "const": "actionResolved" },
            "action": { "type": "string" }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["type"],
          "properties": {
            "type": { "const": "tokenEntered" },
            "zone": { "type": "string" }
          }
        }
      ]
    },
    "moveParamScalar": {
      "anyOf": [
        { "type": "number" },
        { "type": "string" },
        { "type": "boolean" }
      ]
    },
    "moveParamValue": {
      "anyOf": [
        { "$ref": "#/definitions/moveParamScalar" },
        {
          "type": "array",
          "items": { "$ref": "#/definitions/moveParamScalar" }
        }
      ]
    },
    "move": {
      "type": "object",
      "additionalProperties": false,
      "required": ["actionId", "params"],
      "properties": {
        "actionId": { "type": "string" },
        "params": {
          "type": "object",
          "additionalProperties": { "$ref": "#/definitions/moveParamValue" }
        },
        "freeOperation": { "type": "boolean" },
        "compound": {
          "type": "object",
          "additionalProperties": false,
          "required": ["specialActivity", "timing"],
          "properties": {
            "specialActivity": { "$ref": "#/definitions/move" },
            "timing": { "type": "string", "enum": ["before", "during", "after"] },
            "insertAfterStage": { "type": "integer", "minimum": 0 }
          }
        }
      }
    },
    "stateDelta": {
      "type": "object",
      "additionalProperties": false,
      "required": ["path", "before", "after"],
      "properties": {
        "path": { "type": "string" },
        "before": {},
        "after": {}
      }
    },
    "triggerFiring": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "triggerId", "event", "depth"],
      "properties": {
        "kind": { "const": "fired" },
        "triggerId": { "type": "string" },
        "event": { "$ref": "#/definitions/triggerEvent" },
        "depth": { "type": "number" }
      }
    },
    "triggerTruncated": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "event", "depth"],
      "properties": {
        "kind": { "const": "truncated" },
        "event": { "$ref": "#/definitions/triggerEvent" },
        "depth": { "type": "number" }
      }
    },
    "turnFlowDuration": {
      "enum": ["turn", "nextTurn", "round", "cycle"]
    },
    "turnFlowPendingEligibilityOverride": {
      "type": "object",
      "additionalProperties": false,
      "required": ["faction", "eligible", "windowId", "duration"],
      "properties": {
        "faction": { "type": "string" },
        "eligible": { "type": "boolean" },
        "windowId": { "type": "string" },
        "duration": { "$ref": "#/definitions/turnFlowDuration" }
      }
    },
    "turnFlowRuntimeCardState": {
      "type": "object",
      "additionalProperties": false,
      "required": ["firstEligible", "secondEligible", "actedFactions", "passedFactions", "nonPassCount", "firstActionClass"],
      "properties": {
        "firstEligible": { "type": ["string", "null"] },
        "secondEligible": { "type": ["string", "null"] },
        "actedFactions": { "type": "array", "items": { "type": "string" } },
        "passedFactions": { "type": "array", "items": { "type": "string" } },
        "nonPassCount": { "type": "number" },
        "firstActionClass": { "enum": ["event", "operation", "operationPlusSpecialActivity", null] }
      }
    },
    "turnFlowRuntimeState": {
      "type": "object",
      "additionalProperties": false,
      "required": ["factionOrder", "eligibility", "currentCard"],
      "properties": {
        "factionOrder": { "type": "array", "items": { "type": "string" } },
        "eligibility": {
          "type": "object",
          "additionalProperties": { "type": "boolean" }
        },
        "currentCard": { "$ref": "#/definitions/turnFlowRuntimeCardState" },
        "pendingEligibilityOverrides": {
          "type": "array",
          "items": { "$ref": "#/definitions/turnFlowPendingEligibilityOverride" }
        },
        "consecutiveCoupRounds": { "type": "number" },
        "compoundAction": {
          "type": "object",
          "additionalProperties": false,
          "required": ["operationProfileId", "saTiming"],
          "properties": {
            "operationProfileId": { "type": "string", "minLength": 1 },
            "saTiming": {
              "oneOf": [
                { "type": "string", "enum": ["before", "during", "after"] },
                { "type": "null" }
              ]
            }
          }
        }
      }
    },
    "turnOrderRuntimeState": {
      "oneOf": [
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["type"],
          "properties": {
            "type": { "const": "roundRobin" }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["type", "currentIndex"],
          "properties": {
            "type": { "const": "fixedOrder" },
            "currentIndex": { "type": "number" }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["type", "runtime"],
          "properties": {
            "type": { "const": "cardDriven" },
            "runtime": { "$ref": "#/definitions/turnFlowRuntimeState" }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["type", "submitted"],
          "properties": {
            "type": { "const": "simultaneous" },
            "submitted": {
              "type": "object",
              "additionalProperties": { "type": "boolean" }
            }
          }
        }
      ]
    },
    "turnFlowLifecycleStep": {
      "enum": [
        "initialRevealPlayed",
        "initialRevealLookahead",
        "promoteLookaheadToPlayed",
        "revealLookahead",
        "coupToLeader",
        "coupHandoff"
      ]
    },
    "turnFlowLifecycleTraceEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "step", "slots", "before", "after"],
      "properties": {
        "kind": { "const": "turnFlowLifecycle" },
        "step": { "$ref": "#/definitions/turnFlowLifecycleStep" },
        "slots": {
          "type": "object",
          "additionalProperties": false,
          "required": ["played", "lookahead", "leader"],
          "properties": {
            "played": { "type": "string" },
            "lookahead": { "type": "string" },
            "leader": { "type": "string" }
          }
        },
        "before": {
          "type": "object",
          "additionalProperties": false,
          "required": ["playedCardId", "lookaheadCardId", "leaderCardId"],
          "properties": {
            "playedCardId": { "type": ["string", "null"] },
            "lookaheadCardId": { "type": ["string", "null"] },
            "leaderCardId": { "type": ["string", "null"] }
          }
        },
        "after": {
          "type": "object",
          "additionalProperties": false,
          "required": ["playedCardId", "lookaheadCardId", "leaderCardId"],
          "properties": {
            "playedCardId": { "type": ["string", "null"] },
            "lookaheadCardId": { "type": ["string", "null"] },
            "leaderCardId": { "type": ["string", "null"] }
          }
        }
      }
    },
    "turnFlowEligibilityTraceEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "step", "faction", "before", "after"],
      "properties": {
        "kind": { "const": "turnFlowEligibility" },
        "step": { "enum": ["candidateScan", "passChain", "cardEnd", "overrideCreate"] },
        "faction": { "type": ["string", "null"] },
        "before": { "$ref": "#/definitions/turnFlowRuntimeCardState" },
        "after": { "$ref": "#/definitions/turnFlowRuntimeCardState" },
        "eligibilityBefore": {
          "type": "object",
          "additionalProperties": { "type": "boolean" }
        },
        "eligibilityAfter": {
          "type": "object",
          "additionalProperties": { "type": "boolean" }
        },
        "rewards": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["resource", "amount"],
            "properties": {
              "resource": { "type": "string" },
              "amount": { "type": "number" }
            }
          }
        },
        "overrides": {
          "type": "array",
          "items": { "$ref": "#/definitions/turnFlowPendingEligibilityOverride" }
        },
        "reason": { "enum": ["rightmostPass", "twoNonPass"] }
      }
    },
    "operationPartialTraceEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "actionId", "profileId", "step", "reason"],
      "properties": {
        "kind": { "const": "operationPartial" },
        "actionId": { "type": "string" },
        "profileId": { "type": "string" },
        "step": { "const": "costSpendSkipped" },
        "reason": { "const": "costValidationFailed" }
      }
    },
    "triggerLogEntry": {
      "oneOf": [
        { "$ref": "#/definitions/triggerFiring" },
        { "$ref": "#/definitions/triggerTruncated" },
        { "$ref": "#/definitions/turnFlowLifecycleTraceEntry" },
        { "$ref": "#/definitions/turnFlowEligibilityTraceEntry" },
        { "$ref": "#/definitions/operationPartialTraceEntry" }
      ]
    },
    "serializedRngState": {
      "type": "object",
      "additionalProperties": false,
      "required": ["algorithm", "version", "state"],
      "properties": {
        "algorithm": { "const": "pcg-dxsm-128" },
        "version": { "const": 1 },
        "state": {
          "type": "array",
          "minItems": 2,
          "maxItems": 2,
          "items": { "$ref": "#/definitions/hexBigInt" }
        }
      }
    },
    "token": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "type", "props"],
      "properties": {
        "id": { "type": "string" },
        "type": { "type": "string" },
        "props": {
          "type": "object",
          "additionalProperties": {
            "anyOf": [{ "type": "number" }, { "type": "string" }, { "type": "boolean" }]
          }
        }
      }
    },
    "actionUsageRecord": {
      "type": "object",
      "additionalProperties": false,
      "required": ["turnCount", "phaseCount", "gameCount"],
      "properties": {
        "turnCount": { "type": "number" },
        "phaseCount": { "type": "number" },
        "gameCount": { "type": "number" }
      }
    },
    "serializedGameState": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "globalVars",
        "perPlayerVars",
        "playerCount",
        "zones",
        "nextTokenOrdinal",
        "currentPhase",
        "activePlayer",
        "turnCount",
        "rng",
        "stateHash",
        "actionUsage",
        "turnOrderState",
        "markers"
      ],
      "properties": {
        "globalVars": {
          "type": "object",
          "additionalProperties": { "type": "number" }
        },
        "perPlayerVars": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "additionalProperties": { "type": "number" }
          }
        },
        "playerCount": { "type": "number" },
        "zones": {
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": { "$ref": "#/definitions/token" }
          }
        },
        "nextTokenOrdinal": { "type": "number" },
        "currentPhase": { "type": "string" },
        "activePlayer": { "type": "integer" },
        "turnCount": { "type": "number" },
        "rng": { "$ref": "#/definitions/serializedRngState" },
        "stateHash": { "$ref": "#/definitions/hexBigInt" },
        "actionUsage": {
          "type": "object",
          "additionalProperties": { "$ref": "#/definitions/actionUsageRecord" }
        },
        "markers": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "additionalProperties": { "type": "string" }
          }
        },
        "turnOrderState": { "$ref": "#/definitions/turnOrderRuntimeState" }
      }
    },
    "serializedMoveLog": {
      "type": "object",
      "additionalProperties": false,
      "required": ["stateHash", "player", "move", "legalMoveCount", "deltas", "triggerFirings", "warnings"],
      "properties": {
        "stateHash": { "$ref": "#/definitions/hexBigInt" },
        "player": { "type": "integer" },
        "move": { "$ref": "#/definitions/move" },
        "legalMoveCount": { "type": "number" },
        "deltas": {
          "type": "array",
          "items": { "$ref": "#/definitions/stateDelta" }
        },
        "triggerFirings": {
          "type": "array",
          "items": { "$ref": "#/definitions/triggerLogEntry" }
        },
        "warnings": {
          "type": "array",
          "items": { "$ref": "#/definitions/runtimeWarning" }
        },
        "effectTrace": {
          "type": "array",
          "items": { "$ref": "#/definitions/effectTraceEntry" }
        }
      }
    },
    "runtimeWarning": {
      "type": "object",
      "additionalProperties": false,
      "required": ["code", "message", "context"],
      "properties": {
        "code": {
          "enum": [
            "EMPTY_QUERY_RESULT",
            "TOKEN_NOT_IN_ZONE",
            "BINDING_UNDEFINED",
            "EMPTY_ZONE_OPERATION",
            "ZERO_EFFECT_ITERATIONS"
          ]
        },
        "message": { "type": "string" },
        "context": { "type": "object" },
        "hint": { "type": "string" }
      }
    },
    "effectTraceEntry": {
      "oneOf": [
        {
          "type": "object",
          "required": ["kind", "collection", "count"],
          "properties": {
            "kind": { "const": "forEach" },
            "collection": { "type": "string" },
            "count": { "type": "number" }
          }
        },
        {
          "type": "object",
          "required": ["kind", "tokenId", "from", "to"],
          "properties": {
            "kind": { "const": "moveToken" },
            "tokenId": { "type": "string" },
            "from": { "type": "string" },
            "to": { "type": "string" }
          }
        },
        {
          "type": "object",
          "required": ["kind", "tokenId", "prop", "before", "after"],
          "properties": {
            "kind": { "const": "setTokenProp" },
            "tokenId": { "type": "string" },
            "prop": { "type": "string" },
            "before": {},
            "after": {}
          }
        },
        {
          "type": "object",
          "required": ["kind", "scope", "var", "before", "after"],
          "properties": {
            "kind": { "const": "varChange" },
            "scope": { "type": "string" },
            "var": { "type": "string" },
            "before": {},
            "after": {}
          }
        },
        {
          "type": "object",
          "required": ["kind", "tokenId", "tokenType", "zone"],
          "properties": {
            "kind": { "const": "createToken" },
            "tokenId": { "type": "string" },
            "tokenType": { "type": "string" },
            "zone": { "type": "string" }
          }
        },
        {
          "type": "object",
          "required": ["kind", "query", "resultCount"],
          "properties": {
            "kind": { "const": "queryResult" },
            "query": { "type": "string" },
            "resultCount": { "type": "number" }
          }
        },
        {
          "type": "object",
          "required": ["kind", "condition", "result"],
          "properties": {
            "kind": { "const": "conditional" },
            "condition": { "type": "string" },
            "result": { "type": "boolean" }
          }
        }
      ]
    },
    "playerScore": {
      "type": "object",
      "additionalProperties": false,
      "required": ["player", "score"],
      "properties": {
        "player": { "type": "integer" },
        "score": { "type": "number" }
      }
    },
    "terminalResult": {
      "oneOf": [
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["type", "player"],
          "properties": {
            "type": { "const": "win" },
            "player": { "type": "integer" }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["type"],
          "properties": {
            "type": { "const": "lossAll" }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["type"],
          "properties": {
            "type": { "const": "draw" }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["type", "ranking"],
          "properties": {
            "type": { "const": "score" },
            "ranking": {
              "type": "array",
              "items": { "$ref": "#/definitions/playerScore" }
            }
          }
        }
      ]
    }
  }
}
