# SESSMGMT-009: Dexie.js Database and Save Manager (Spec 43 D5 — persistence layer)

**Status**: PENDING
**Priority**: MEDIUM
**Effort**: Medium
**Engine Changes**: None — runner-only
**Deps**: SESSMGMT-004

## Problem

The runner needs IndexedDB-backed persistence for saving and loading games. This ticket implements the database schema and CRUD operations.

## What to Change

### 1. Add `dexie` dependency

```bash
pnpm -F @ludoforge/runner add dexie
```

### 2. Create `packages/runner/src/persistence/game-db.ts`

Define the Dexie database class:

```typescript
import Dexie from 'dexie';

export interface SavedGameRecord {
  readonly id: string;           // Auto-generated UUID
  readonly gameId: string;       // Bootstrap target id (e.g., 'fitl', 'texas')
  readonly gameName: string;     // Human-readable (e.g., 'Fire in the Lake')
  readonly displayName: string;  // User-provided save name
  readonly timestamp: number;    // Date.now()
  readonly seed: string;         // Original seed (stringified BigInt)
  readonly moveHistory: Move[];  // Complete move sequence
  readonly playerConfig: PlayerSeatConfig[];
  readonly playerId: number;     // Which seat the human was playing
  readonly moveCount: number;    // Length of moveHistory (for display)
  readonly isTerminal: boolean;  // Whether the game was finished
}
```

Dexie database class with a `saves` table, indexed by `id`, `gameId`, and `timestamp`.

### 3. Create `packages/runner/src/persistence/save-manager.ts`

Pure functions that operate on the Dexie database:

- `saveGame(record: Omit<SavedGameRecord, 'id'>): Promise<string>` — generates UUID via `crypto.randomUUID()`, stores record, returns id.
- `loadGame(id: string): Promise<SavedGameRecord | undefined>` — retrieves by id.
- `listSavedGames(gameId?: string): Promise<SavedGameRecord[]>` — lists saves, optionally filtered by gameId, ordered by timestamp descending.
- `deleteSavedGame(id: string): Promise<void>` — deletes by id.

## Files to Touch

- `packages/runner/package.json` (add `dexie` dependency)
- `packages/runner/src/persistence/game-db.ts` (new)
- `packages/runner/src/persistence/save-manager.ts` (new)
- `packages/runner/test/persistence/save-manager.test.ts` (new)

## Out of Scope

- UI dialogs for save/load (SESSMGMT-010)
- Move accumulation wiring (SESSMGMT-008)
- Replay controller (SESSMGMT-011, 012)
- Game selection screen save list integration (wired in SESSMGMT-010)
- Session store changes (done in SESSMGMT-004)

## Acceptance Criteria

### Tests That Must Pass

1. **`saveGame` creates record**: After `saveGame(record)`, the returned id can be used with `loadGame(id)` to retrieve the same record.
2. **`loadGame` returns undefined for missing id**: `loadGame('nonexistent')` returns `undefined`.
3. **`listSavedGames` returns all**: After saving 3 games, `listSavedGames()` returns all 3.
4. **`listSavedGames` filters by gameId**: After saving 2 FITL and 1 Texas games, `listSavedGames('fitl')` returns 2.
5. **`listSavedGames` orders by timestamp desc**: Most recent save appears first.
6. **`deleteSavedGame` removes record**: After deleting, `loadGame(id)` returns `undefined`.
7. **Seed stored as string**: BigInt seeds are stored as strings and can be parsed back to BigInt.
8. **Existing runner tests**: `pnpm -F @ludoforge/runner test` passes.

### Invariants

1. `SavedGameRecord.id` is a UUID generated by `crypto.randomUUID()`.
2. `SavedGameRecord.seed` is a string representation of a BigInt (not a number).
3. `moveHistory` is stored as a complete array in a single IndexedDB record (no chunking).
4. The database name and table name are stable (no random suffixes) so saves persist across sessions.
5. No direct Dexie imports outside of `persistence/` — the save manager is the public API.

Note: Dexie.js IndexedDB tests may require `fake-indexeddb` or similar in the Vitest environment. If the test framework doesn't support IndexedDB natively, use `fake-indexeddb` as a dev dependency.
